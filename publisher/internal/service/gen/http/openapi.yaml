swagger: "2.0"
info:
    title: Publish API
    description: Publish API
    contact:
        name: WuHui Zuo
        email: wuhui.zuo@pingcap.com
        url: https://github.com/wuhuizuo
    version: 1.0.0
host: 0.0.0.0:80
consumes:
    - application/json
    - application/xml
    - application/gob
produces:
    - application/json
    - application/xml
    - application/gob
paths:
    /fs/publish-request:
        post:
            tags:
                - fileserver
            summary: request-to-publish fileserver
            operationId: fileserver#request-to-publish
            parameters:
                - name: Request-To-PublishRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/FileserverRequestToPublishRequestBody'
                    required:
                        - artifact_url
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: array
                        items:
                            type: string
                            description: Request id for async mode (uuidv4 format)
                            example: 2699eb5d-a56d-47af-a578-5950e5961665
                            format: uuid
            schemes:
                - http
    /fs/publish-request/{request_id}:
        get:
            tags:
                - fileserver
            summary: query-publishing-status fileserver
            operationId: fileserver#query-publishing-status
            parameters:
                - name: request_id
                  in: path
                  description: Request id for async mode (uuidv4 format)
                  required: true
                  type: string
                  format: uuid
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: string
                        enum:
                            - queued
                            - processing
                            - success
                            - failed
                            - canceled
            schemes:
                - http
    /image/collect-multiarch:
        post:
            tags:
                - image
            summary: request-multiarch-collect image
            operationId: image#request-multiarch-collect
            parameters:
                - name: Request-Multiarch-CollectRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/ImageRequestMultiarchCollectRequestBody'
                    required:
                        - image_url
            responses:
                "200":
                    description: OK response.
                    schema:
                        $ref: '#/definitions/ImageRequestMultiarchCollectResponseBody'
                        required:
                            - async
            schemes:
                - http
    /image/collect-multiarch/{request_id}:
        get:
            tags:
                - image
            summary: query-multiarch-collect-status image
            operationId: image#query-multiarch-collect-status
            parameters:
                - name: request_id
                  in: path
                  description: Request id for async mode (uuidv4 format)
                  required: true
                  type: string
                  format: uuid
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: string
                        enum:
                            - queued
                            - processing
                            - success
                            - failed
                            - canceled
            schemes:
                - http
    /image/copy:
        post:
            tags:
                - image
            summary: request-to-copy image
            operationId: image#request-to-copy
            parameters:
                - name: Request-To-CopyRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/ImageRequestToCopyRequestBody'
                    required:
                        - source
                        - destination
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: string
                        format: uuid
            schemes:
                - http
    /image/copy/{request_id}:
        get:
            tags:
                - image
            summary: query-copying-status image
            operationId: image#query-copying-status
            parameters:
                - name: request_id
                  in: path
                  description: Request id for async mode (uuidv4 format)
                  required: true
                  type: string
                  format: uuid
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: string
                        enum:
                            - queued
                            - processing
                            - success
                            - failed
                            - canceled
            schemes:
                - http
    /tidbcloud/devops/cloudconfig/versions/component:
        post:
            tags:
                - tidbcloud
            summary: update-component-version-in-cloudconfig tidbcloud
            operationId: tidbcloud#update-component-version-in-cloudconfig
            parameters:
                - name: Update-Component-Version-In-CloudconfigRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/TidbcloudUpdateComponentVersionInCloudconfigRequestBody'
                    required:
                        - stage
                        - image
            responses:
                "200":
                    description: OK response.
                    schema:
                        $ref: '#/definitions/TidbcloudUpdateComponentVersionInCloudconfigResponseBody'
                        required:
                            - stage
                            - tickets
            schemes:
                - http
    /tiup/delivery-by-rules:
        post:
            tags:
                - tiup
            summary: delivery-by-rules tiup
            description: Request to delivery TiUP packages from OCI artifact controlled by delivery rules
            operationId: tiup#delivery-by-rules
            parameters:
                - name: Delivery-By-RulesRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/TiupDeliveryByRulesRequestBody'
                    required:
                        - artifact_url
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: array
                        items:
                            type: string
                            example: Tenetur non quisquam qui suscipit nisi architecto.
            schemes:
                - http
    /tiup/publish-request:
        post:
            tags:
                - tiup
            summary: request-to-publish tiup
            description: Request to publish TiUP packages from a OCI artifact
            operationId: tiup#request-to-publish
            parameters:
                - name: Request-To-PublishRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/TiupRequestToPublishRequestBody'
                    required:
                        - artifact_url
                        - tiup_mirror
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: array
                        items:
                            type: string
                            example: Voluptas fugiat reiciendis aliquid aut quam.
            schemes:
                - http
    /tiup/publish-request-single:
        post:
            tags:
                - tiup
            summary: request-to-publish-single tiup
            description: Request to publish a single TiUP package from a binary tarball
            operationId: tiup#request-to-publish-single
            parameters:
                - name: Request-To-Publish-SingleRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/PublishRequestTiUP'
                    required:
                        - from
                        - publish
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: string
                        format: uuid
            schemes:
                - http
    /tiup/publish-request/{request_id}:
        get:
            tags:
                - tiup
            summary: query-publishing-status tiup
            operationId: tiup#query-publishing-status
            parameters:
                - name: request_id
                  in: path
                  description: request track id
                  required: true
                  type: string
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: string
                        enum:
                            - queued
                            - processing
                            - success
                            - failed
                            - canceled
            schemes:
                - http
    /tiup/reset-rate-limit:
        post:
            tags:
                - tiup
            summary: reset-rate-limit tiup
            operationId: tiup#reset-rate-limit
            responses:
                "200":
                    description: OK response.
            schemes:
                - http
definitions:
    FileserverRequestToPublishRequestBody:
        title: FileserverRequestToPublishRequestBody
        type: object
        properties:
            artifact_url:
                type: string
                description: The full url of the pushed OCI artifact, contain the tag part. It will parse the repo from it.
                example: Quis doloribus enim quaerat id id dolorum.
        example:
            artifact_url: Ut dolores inventore.
        required:
            - artifact_url
    From:
        title: From
        type: object
        properties:
            http:
                $ref: '#/definitions/FromHTTP'
            oci:
                $ref: '#/definitions/FromOci'
            type:
                type: string
                example: oci
                enum:
                    - oci
                    - http
        example:
            http:
                url: https://example.com/tidb-v7.5.0-linux-amd64.tar.gz
            type: http
        required:
            - type
    FromHTTP:
        title: FromHTTP
        type: object
        properties:
            url:
                type: string
                example: https://example.com/tidb-v7.5.0-linux-amd64.tar.gz
        description: Source from a direct HTTP URL
        example:
            url: https://example.com/tidb-v7.5.0-linux-amd64.tar.gz
        required:
            - url
    FromOci:
        title: FromOci
        type: object
        properties:
            file:
                type: string
                example: tidb-v7.5.0-linux-amd64.tar.gz
            repo:
                type: string
                example: hub.pingcap.net/dev/ci/tidb
            tag:
                type: string
                example: v7.5.0_linux_amd64
        description: Source from an OCI artifact
        example:
            file: tidb-v7.5.0-linux-amd64.tar.gz
            repo: hub.pingcap.net/dev/ci/tidb
            tag: v7.5.0_linux_amd64
        required:
            - repo
            - tag
            - file
    ImageRequestMultiarchCollectRequestBody:
        title: ImageRequestMultiarchCollectRequestBody
        type: object
        properties:
            async:
                type: boolean
                description: Whether to run the collection asynchronously. If true, returns a request id. If false or omitted, runs synchronously and returns the result directly.
                default: false
                example: true
            image_url:
                type: string
                description: The image URL to collect
                example: Ut perspiciatis beatae aut voluptas molestiae asperiores.
            release_tag_suffix:
                type: string
                description: Suffix for the release tag
                default: release
                example: Sequi consequuntur sit eaque illo in.
        example:
            async: false
            image_url: Reprehenderit non omnis consequatur perferendis.
            release_tag_suffix: Aut culpa quo.
        required:
            - image_url
    ImageRequestMultiarchCollectResponseBody:
        title: ImageRequestMultiarchCollectResponseBody
        type: object
        properties:
            async:
                type: boolean
                description: Whether to run the collection asynchronously. If true, returns a request id. If false or omitted, runs synchronously and returns the result directly.
                default: false
                example: true
            repo:
                type: string
                description: Repository of the collected image
                example: Voluptatem aut non aut sapiente et.
            request_id:
                type: string
                description: Request id for async mode (uuidv4 format)
                example: ed1835c3-fff0-43d6-a163-0afb65148f1b
                format: uuid
            tags:
                type: array
                items:
                    type: string
                    example: Voluptatem excepturi nemo est et.
                description: Tags of the collected image
                example:
                    - Dolorem aperiam nobis quaerat debitis labore.
                    - Sit accusamus maxime aut repudiandae.
        example:
            async: false
            repo: Quisquam amet voluptas dolores enim deleniti et.
            request_id: 8235f013-5f43-4aa7-bee5-b0de4d8e511c
            tags:
                - Eveniet veritatis natus ratione voluptas ullam quam.
                - Magni quo rerum et ut odit consectetur.
        required:
            - async
    ImageRequestToCopyRequestBody:
        title: ImageRequestToCopyRequestBody
        type: object
        properties:
            destination:
                type: string
                description: destination image url
                example: Quia velit voluptas.
            source:
                type: string
                description: source image url
                example: In consequuntur aut.
        example:
            destination: Pariatur mollitia consequatur.
            source: Aliquam velit minus dignissimos fuga corporis.
        required:
            - source
            - destination
    PublishInfoTiUP:
        title: PublishInfoTiUP
        type: object
        properties:
            arch:
                type: string
                example: amd64
            description:
                type: string
                example: TiDB GA
            entry_point:
                type: string
                example: bin/tidb-server
            name:
                type: string
                example: tidb
            os:
                type: string
                example: linux
            standalone:
                type: boolean
                example: false
            version:
                type: string
                example: v7.5.0
        example:
            arch: amd64
            description: TiDB GA
            entry_point: bin/tidb-server
            name: tidb
            os: linux
            standalone: false
            version: v7.5.0
        required:
            - name
            - os
            - arch
            - version
    PublishRequestTiUP:
        title: PublishRequestTiUP
        type: object
        properties:
            from:
                $ref: '#/definitions/From'
            publish:
                $ref: '#/definitions/PublishInfoTiUP'
            tiup_mirror:
                type: string
                description: '`staging` is http://tiup.pingcap.net:8988, `prod` is http://tiup.pingcap.net:8987.'
                default: staging
                example: staging
                enum:
                    - staging
                    - prod
        example:
            from:
                http:
                    url: https://example.com/tidb-v7.5.0-linux-amd64.tar.gz
                type: http
            publish:
                arch: amd64
                description: TiDB GA
                entry_point: bin/tidb-server
                name: tidb
                os: linux
                standalone: false
                version: v7.5.0
        required:
            - from
            - publish
    TidbcloudOpsTicket:
        title: TidbcloudOpsTicket
        type: object
        properties:
            change_id:
                type: string
                description: component publish flow ID
                example: Porro adipisci dolore earum dolorem.
            component:
                type: string
                description: component name
                example: Id sunt voluptatem rem pariatur a magnam.
            component_version:
                type: string
                description: component version derived from image tag
                example: Neque optio et ad unde possimus et.
            id:
                type: string
                description: ticket ID
                example: Non ea amet.
            release_id:
                type: string
                description: release window ID
                example: Earum id alias consequatur ut officiis.
            url:
                type: string
                description: ticket visit url
                example: http://strosin.net/jevon
                format: uri
        description: Ops ticket details
        example:
            change_id: Omnis deleniti sit sit consectetur reprehenderit.
            component: Totam aspernatur nemo.
            component_version: Molestiae possimus doloremque hic.
            id: Est alias ea quo et repellendus.
            release_id: Nobis eaque ex quis eum et.
            url: http://osinskischaefer.info/thomas
        required:
            - id
            - url
            - component
            - component_version
    TidbcloudUpdateComponentVersionInCloudconfigRequestBody:
        title: TidbcloudUpdateComponentVersionInCloudconfigRequestBody
        type: object
        properties:
            image:
                type: string
                description: container image with tag
                example: xxx.com/coomponent:v8.5.4
            stage:
                type: string
                description: env stage
                example: prod
        example:
            image: xxx.com/coomponent:v8.5.4
            stage: prod
        required:
            - stage
            - image
    TidbcloudUpdateComponentVersionInCloudconfigResponseBody:
        title: TidbcloudUpdateComponentVersionInCloudconfigResponseBody
        type: object
        properties:
            stage:
                type: string
                example: Quod illo sunt est.
            tickets:
                type: array
                items:
                    $ref: '#/definitions/TidbcloudOpsTicket'
                example:
                    - change_id: Necessitatibus veritatis.
                      component: Qui unde reiciendis quibusdam quibusdam veniam.
                      component_version: Rerum excepturi omnis autem sequi saepe.
                      id: Occaecati animi.
                      release_id: Officiis corrupti reprehenderit.
                      url: http://schuppe.name/nelda
                    - change_id: Necessitatibus veritatis.
                      component: Qui unde reiciendis quibusdam quibusdam veniam.
                      component_version: Rerum excepturi omnis autem sequi saepe.
                      id: Occaecati animi.
                      release_id: Officiis corrupti reprehenderit.
                      url: http://schuppe.name/nelda
                    - change_id: Necessitatibus veritatis.
                      component: Qui unde reiciendis quibusdam quibusdam veniam.
                      component_version: Rerum excepturi omnis autem sequi saepe.
                      id: Occaecati animi.
                      release_id: Officiis corrupti reprehenderit.
                      url: http://schuppe.name/nelda
        example:
            stage: Inventore cupiditate qui.
            tickets:
                - change_id: Necessitatibus veritatis.
                  component: Qui unde reiciendis quibusdam quibusdam veniam.
                  component_version: Rerum excepturi omnis autem sequi saepe.
                  id: Occaecati animi.
                  release_id: Officiis corrupti reprehenderit.
                  url: http://schuppe.name/nelda
                - change_id: Necessitatibus veritatis.
                  component: Qui unde reiciendis quibusdam quibusdam veniam.
                  component_version: Rerum excepturi omnis autem sequi saepe.
                  id: Occaecati animi.
                  release_id: Officiis corrupti reprehenderit.
                  url: http://schuppe.name/nelda
        required:
            - stage
            - tickets
    TiupDeliveryByRulesRequestBody:
        title: TiupDeliveryByRulesRequestBody
        type: object
        properties:
            artifact_url:
                type: string
                description: The full url of the pushed OCI artifact, contain the tag part. It will parse the repo from it.
                example: oci.com/repo:tag
        example:
            artifact_url: oci.com/repo:tag
        required:
            - artifact_url
    TiupRequestToPublishRequestBody:
        title: TiupRequestToPublishRequestBody
        type: object
        properties:
            artifact_url:
                type: string
                description: The full url of the pushed OCI artifact, contain the tag part. It will parse the repo from it.
                example: oci.com/repo:tag
            tiup_mirror:
                type: string
                description: '`staging` is http://tiup.pingcap.net:8988, `prod` is http://tiup.pingcap.net:8987.'
                default: staging
                example: prod
                enum:
                    - staging
                    - prod
            version:
                type: string
                description: Force set the version. Default is the artifact version read from `org.opencontainers.image.version` of the manifest config.
                example: v1.0.0
        example:
            artifact_url: oci.com/repo:tag
            tiup_mirror: staging
            version: v1.0.0
        required:
            - artifact_url
            - tiup_mirror
