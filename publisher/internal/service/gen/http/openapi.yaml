swagger: "2.0"
info:
    title: Publish API
    description: Publish API
    contact:
        name: WuHui Zuo
        email: wuhui.zuo@pingcap.com
        url: https://github.com/wuhuizuo
    version: 1.0.0
host: 0.0.0.0:80
consumes:
    - application/json
    - application/xml
    - application/gob
produces:
    - application/json
    - application/xml
    - application/gob
paths:
    /fs/publish-request:
        post:
            tags:
                - fileserver
            summary: request-to-publish fileserver
            operationId: fileserver#request-to-publish
            parameters:
                - name: Request-To-PublishRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/FileserverRequestToPublishRequestBody'
                    required:
                        - artifact_url
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: array
                        items:
                            type: string
                            description: Request id for async mode (uuidv4 format)
                            example: 1f3d1cf9-b321-4bdc-8ae1-4509f419cb94
                            format: uuid
            schemes:
                - http
    /fs/publish-request/{request_id}:
        get:
            tags:
                - fileserver
            summary: query-publishing-status fileserver
            operationId: fileserver#query-publishing-status
            parameters:
                - name: request_id
                  in: path
                  description: Request id for async mode (uuidv4 format)
                  required: true
                  type: string
                  format: uuid
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: string
                        enum:
                            - queued
                            - processing
                            - success
                            - failed
                            - canceled
            schemes:
                - http
    /image/collect-multiarch:
        post:
            tags:
                - image
            summary: request-multiarch-collect image
            operationId: image#request-multiarch-collect
            parameters:
                - name: Request-Multiarch-CollectRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/ImageRequestMultiarchCollectRequestBody'
                    required:
                        - image_url
            responses:
                "200":
                    description: OK response.
                    schema:
                        $ref: '#/definitions/ImageRequestMultiarchCollectResponseBody'
                        required:
                            - async
            schemes:
                - http
    /image/collect-multiarch/{request_id}:
        get:
            tags:
                - image
            summary: query-multiarch-collect-status image
            operationId: image#query-multiarch-collect-status
            parameters:
                - name: request_id
                  in: path
                  description: Request id for async mode (uuidv4 format)
                  required: true
                  type: string
                  format: uuid
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: string
                        enum:
                            - queued
                            - processing
                            - success
                            - failed
                            - canceled
            schemes:
                - http
    /image/copy:
        post:
            tags:
                - image
            summary: request-to-copy image
            operationId: image#request-to-copy
            parameters:
                - name: Request-To-CopyRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/ImageRequestToCopyRequestBody'
                    required:
                        - source
                        - destination
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: string
                        format: uuid
            schemes:
                - http
    /image/copy/{request_id}:
        get:
            tags:
                - image
            summary: query-copying-status image
            operationId: image#query-copying-status
            parameters:
                - name: request_id
                  in: path
                  description: Request id for async mode (uuidv4 format)
                  required: true
                  type: string
                  format: uuid
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: string
                        enum:
                            - queued
                            - processing
                            - success
                            - failed
                            - canceled
            schemes:
                - http
    /tiup/delivery-by-rules:
        post:
            tags:
                - tiup
            summary: delivery-by-rules tiup
            description: Request to delivery TiUP packages from OCI artifact controlled by delivery rules
            operationId: tiup#delivery-by-rules
            parameters:
                - name: Delivery-By-RulesRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/TiupDeliveryByRulesRequestBody'
                    required:
                        - artifact_url
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: array
                        items:
                            type: string
                            example: Ipsam eos vitae et officiis inventore.
            schemes:
                - http
    /tiup/publish-request:
        post:
            tags:
                - tiup
            summary: request-to-publish tiup
            description: Request to publish TiUP packages from a OCI artifact
            operationId: tiup#request-to-publish
            parameters:
                - name: Request-To-PublishRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/TiupRequestToPublishRequestBody'
                    required:
                        - artifact_url
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: array
                        items:
                            type: string
                            example: Enim suscipit.
            schemes:
                - http
    /tiup/publish-request-single:
        post:
            tags:
                - tiup
            summary: request-to-publish-single tiup
            description: Request to publish a single TiUP package from a binary tarball
            operationId: tiup#request-to-publish-single
            parameters:
                - name: Request-To-Publish-SingleRequestBody
                  in: body
                  required: true
                  schema:
                    $ref: '#/definitions/PublishRequestTiUP'
                    required:
                        - from
                        - publish
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: string
                        format: uuid
            schemes:
                - http
    /tiup/publish-request/{request_id}:
        get:
            tags:
                - tiup
            summary: query-publishing-status tiup
            operationId: tiup#query-publishing-status
            parameters:
                - name: request_id
                  in: path
                  description: request track id
                  required: true
                  type: string
            responses:
                "200":
                    description: OK response.
                    schema:
                        type: string
                        enum:
                            - queued
                            - processing
                            - success
                            - failed
                            - canceled
            schemes:
                - http
    /tiup/reset-rate-limit:
        post:
            tags:
                - tiup
            summary: reset-rate-limit tiup
            operationId: tiup#reset-rate-limit
            responses:
                "200":
                    description: OK response.
            schemes:
                - http
definitions:
    FileserverRequestToPublishRequestBody:
        title: FileserverRequestToPublishRequestBody
        type: object
        properties:
            artifact_url:
                type: string
                description: The full url of the pushed OCI artifact, contain the tag part. It will parse the repo from it.
                example: Quam numquam quo.
        example:
            artifact_url: Expedita cum nisi officiis corrupti reprehenderit saepe.
        required:
            - artifact_url
    From:
        title: From
        type: object
        properties:
            http:
                $ref: '#/definitions/FromHTTP'
            oci:
                $ref: '#/definitions/FromOci'
            type:
                type: string
                example: oci
                enum:
                    - oci
                    - http
        example:
            http:
                url: https://example.com/tidb-v7.5.0-linux-amd64.tar.gz
            type: http
        required:
            - type
    FromHTTP:
        title: FromHTTP
        type: object
        properties:
            url:
                type: string
                example: https://example.com/tidb-v7.5.0-linux-amd64.tar.gz
        description: Source from a direct HTTP URL
        example:
            url: https://example.com/tidb-v7.5.0-linux-amd64.tar.gz
        required:
            - url
    FromOci:
        title: FromOci
        type: object
        properties:
            file:
                type: string
                example: tidb-v7.5.0-linux-amd64.tar.gz
            repo:
                type: string
                example: hub.pingcap.net/dev/ci/tidb
            tag:
                type: string
                example: v7.5.0_linux_amd64
        description: Source from an OCI artifact
        example:
            file: tidb-v7.5.0-linux-amd64.tar.gz
            repo: hub.pingcap.net/dev/ci/tidb
            tag: v7.5.0_linux_amd64
        required:
            - repo
            - tag
            - file
    ImageRequestMultiarchCollectRequestBody:
        title: ImageRequestMultiarchCollectRequestBody
        type: object
        properties:
            async:
                type: boolean
                description: Whether to run the collection asynchronously. If true, returns a request id. If false or omitted, runs synchronously and returns the result directly.
                default: false
                example: false
            image_url:
                type: string
                description: The image URL to collect
                example: Animi doloremque.
            release_tag_suffix:
                type: string
                description: Suffix for the release tag
                default: release
                example: Corrupti tempore quibusdam reprehenderit porro eaque.
        example:
            async: true
            image_url: Rerum aut sequi sequi nihil.
            release_tag_suffix: Consequatur eveniet molestias.
        required:
            - image_url
    ImageRequestMultiarchCollectResponseBody:
        title: ImageRequestMultiarchCollectResponseBody
        type: object
        properties:
            async:
                type: boolean
                description: Whether to run the collection asynchronously. If true, returns a request id. If false or omitted, runs synchronously and returns the result directly.
                default: false
                example: false
            repo:
                type: string
                description: Repository of the collected image
                example: Recusandae quos dolorum voluptas fugiat reiciendis aliquid.
            request_id:
                type: string
                description: Request id for async mode (uuidv4 format)
                example: d0d723af-8a95-45db-9ae0-249518735e10
                format: uuid
            tags:
                type: array
                items:
                    type: string
                    example: Quam accusantium aliquid laborum.
                description: Tags of the collected image
                example:
                    - Quisquam qui suscipit nisi.
                    - Ut commodi.
                    - Quaerat corporis rerum tempore magnam.
                    - Repellat reprehenderit.
        example:
            async: false
            repo: Dolores inventore rerum in consequuntur.
            request_id: 2e9a500d-8abd-42ee-8ac9-2d3fd631a2e1
            tags:
                - Quia velit voluptas.
                - Aliquam velit minus dignissimos fuga corporis.
                - Pariatur mollitia consequatur.
                - Est voluptatem aut non.
        required:
            - async
    ImageRequestToCopyRequestBody:
        title: ImageRequestToCopyRequestBody
        type: object
        properties:
            destination:
                type: string
                description: destination image url
                example: Quibusdam quibusdam veniam nisi rerum.
            source:
                type: string
                description: source image url
                example: Veritatis ipsa qui unde.
        example:
            destination: Fuga occaecati.
            source: Omnis autem sequi.
        required:
            - source
            - destination
    PublishInfoTiUP:
        title: PublishInfoTiUP
        type: object
        properties:
            arch:
                type: string
                example: amd64
            description:
                type: string
                example: TiDB GA
            entry_point:
                type: string
                example: bin/tidb-server
            name:
                type: string
                example: tidb
            os:
                type: string
                example: linux
            standalone:
                type: boolean
                example: false
            version:
                type: string
                example: v7.5.0
        example:
            arch: amd64
            description: TiDB GA
            entry_point: bin/tidb-server
            name: tidb
            os: linux
            standalone: false
            version: v7.5.0
        required:
            - name
            - os
            - arch
            - version
    PublishRequestTiUP:
        title: PublishRequestTiUP
        type: object
        properties:
            from:
                $ref: '#/definitions/From'
            publish:
                $ref: '#/definitions/PublishInfoTiUP'
            tiup_mirror:
                type: string
                description: '`staging` is http://tiup.pingcap.net:8988, `prod` is http://tiup.pingcap.net:8987.'
                default: staging
                example: Aut esse eos itaque dolore.
        example:
            from:
                http:
                    url: https://example.com/tidb-v7.5.0-linux-amd64.tar.gz
                type: http
            publish:
                arch: amd64
                description: TiDB GA
                entry_point: bin/tidb-server
                name: tidb
                os: linux
                standalone: false
                version: v7.5.0
        required:
            - from
            - publish
    TiupDeliveryByRulesRequestBody:
        title: TiupDeliveryByRulesRequestBody
        type: object
        properties:
            artifact_url:
                type: string
                description: The full url of the pushed OCI artifact, contain the tag part. It will parse the repo from it.
                example: oci.com/repo:tag
        example:
            artifact_url: oci.com/repo:tag
        required:
            - artifact_url
    TiupRequestToPublishRequestBody:
        title: TiupRequestToPublishRequestBody
        type: object
        properties:
            artifact_url:
                type: string
                description: The full url of the pushed OCI artifact, contain the tag part. It will parse the repo from it.
                example: oci.com/repo:tag
            tiup_mirror:
                type: string
                description: '`staging` is http://tiup.pingcap.net:8988, `prod` is http://tiup.pingcap.net:8987.'
                default: staging
                example: Quia et.
            version:
                type: string
                description: Force set the version. Default is the artifact version read from `org.opencontainers.image.version` of the manifest config.
                example: v1.0.0
        example:
            artifact_url: oci.com/repo:tag
            tiup_mirror: Ipsa iste.
            version: v1.0.0
        required:
            - artifact_url
